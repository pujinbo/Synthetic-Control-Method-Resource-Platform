gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "L1-L2"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "ridge"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
ci_method <- "ls"   # ✅ 置信区间方法，可选："gaussian" / "ls" / "qreg" / "all"
n_sims <- 500         # 模拟次数
treatment_year <- 1991
# ========== 数据预处理 ==========
data <- data %>%
mutate(id = as.numeric(factor(country))) %>%
arrange(id, year) %>%
group_by(id) %>%
mutate(
gdp_growth = (gdp / lag(gdp) - 1) * 100,
infrate = if (all(is.na(infrate))) NA else na.interp(infrate)
) %>%
ungroup() %>%
filter(!is.na(gdp_growth))
treated_unit <- data$id[data$country == "West Germany"][1]
# ========== 构建数据结构 ==========
df_sc <- scdata(
df = data,
id.var = "id",
time.var = "year",
outcome.var = "gdp_growth",
period.pre = unique(data$year[data$year < treatment_year]),
period.post = unique(data$year[data$year >= treatment_year]),
unit.tr = treated_unit,
unit.co = setdiff(unique(data$id), treated_unit),
constant = TRUE,
cointegrated.data = TRUE
)
# ========== 拟合模型 ==========
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
# ========== 参数设定 ==========
ci_method <- "gaussian"   # ✅ 置信区间方法，可选："gaussian" / "ls" / "qreg" / "all"
n_sims <- 500         # 模拟次数
treatment_year <- 1991
# ========== 数据预处理 ==========
data <- data %>%
mutate(id = as.numeric(factor(country))) %>%
arrange(id, year) %>%
group_by(id) %>%
mutate(
gdp_growth = (gdp / lag(gdp) - 1) * 100,
infrate = if (all(is.na(infrate))) NA else na.interp(infrate)
) %>%
ungroup() %>%
filter(!is.na(gdp_growth))
treated_unit <- data$id[data$country == "West Germany"][1]
# ========== 构建数据结构 ==========
df_sc <- scdata(
df = data,
id.var = "id",
time.var = "year",
outcome.var = "gdp_growth",
period.pre = unique(data$year[data$year < treatment_year]),
period.post = unique(data$year[data$year >= treatment_year]),
unit.tr = treated_unit,
unit.co = setdiff(unique(data$id), treated_unit),
constant = TRUE,
cointegrated.data = TRUE
)
# ========== 拟合模型 ==========
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
ci_method <- "all"   # ✅ 置信区间方法，可选："gaussian" / "ls" / "qreg" / "all"
n_sims <- 500         # 模拟次数
treatment_year <- 1991
# ========== 数据预处理 ==========
data <- data %>%
mutate(id = as.numeric(factor(country))) %>%
arrange(id, year) %>%
group_by(id) %>%
mutate(
gdp_growth = (gdp / lag(gdp) - 1) * 100,
infrate = if (all(is.na(infrate))) NA else na.interp(infrate)
) %>%
ungroup() %>%
filter(!is.na(gdp_growth))
treated_unit <- data$id[data$country == "West Germany"][1]
# ========== 构建数据结构 ==========
df_sc <- scdata(
df = data,
id.var = "id",
time.var = "year",
outcome.var = "gdp_growth",
period.pre = unique(data$year[data$year < treatment_year]),
period.post = unique(data$year[data$year >= treatment_year]),
unit.tr = treated_unit,
unit.co = setdiff(unique(data$id), treated_unit),
constant = TRUE,
cointegrated.data = TRUE
)
# ========== 拟合模型 ==========
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
ci_method <- "qreg"   # ✅ 置信区间方法，可选："gaussian" / "ls" / "qreg" / "all"
n_sims <- 500         # 模拟次数
treatment_year <- 1991
# ========== 数据预处理 ==========
data <- data %>%
mutate(id = as.numeric(factor(country))) %>%
arrange(id, year) %>%
group_by(id) %>%
mutate(
gdp_growth = (gdp / lag(gdp) - 1) * 100,
infrate = if (all(is.na(infrate))) NA else na.interp(infrate)
) %>%
ungroup() %>%
filter(!is.na(gdp_growth))
treated_unit <- data$id[data$country == "West Germany"][1]
# ========== 构建数据结构 ==========
df_sc <- scdata(
df = data,
id.var = "id",
time.var = "year",
outcome.var = "gdp_growth",
period.pre = unique(data$year[data$year < treatment_year]),
period.post = unique(data$year[data$year >= treatment_year]),
unit.tr = treated_unit,
unit.co = setdiff(unique(data$id), treated_unit),
constant = TRUE,
cointegrated.data = TRUE
)
# ========== 拟合模型 ==========
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
setwd("C:/Users/浦进博/Desktop/浦进博-连老师/【最重要】研究进度一览/【5】SCM-6月23前出二稿/代码合集/scpi-main/Python")
data <- read_csv("scpi_germany.csv")
# ========== 参数设定 ==========
ci_method <- "qreg"   # ✅ 置信区间方法，可选："gaussian" / "ls" / "qreg" / "all"
n_sims <- 500         # 模拟次数
treatment_year <- 1991
# ========== 数据预处理 ==========
data <- data %>%
mutate(id = as.numeric(factor(country))) %>%
arrange(id, year) %>%
group_by(id) %>%
mutate(
gdp_growth = (gdp / lag(gdp) - 1) * 100,
infrate = if (all(is.na(infrate))) NA else na.interp(infrate)
) %>%
ungroup() %>%
filter(!is.na(gdp_growth))
treated_unit <- data$id[data$country == "West Germany"][1]
# ========== 构建数据结构 ==========
df_sc <- scdata(
df = data,
id.var = "id",
time.var = "year",
outcome.var = "gdp_growth",
period.pre = unique(data$year[data$year < treatment_year]),
period.post = unique(data$year[data$year >= treatment_year]),
unit.tr = treated_unit,
unit.co = setdiff(unique(data$id), treated_unit),
constant = TRUE,
cointegrated.data = TRUE
)
# ========== 拟合模型 ==========
result <- scpi(
data = df_sc,
sims = n_sims,
e.method = ci_method,  # ✅ 可自由切换
w.constr = list(name = "simplex"),
cores = 2
)
# ========== 效应与置信区间提取 ==========
years_all <- c(df_sc$specs$period.pre, df_sc$specs$period.post)
actual_all <- c(result$data$Y.pre, result$data$Y.post)
synthetic_all <- c(result$est.results$Y.pre.fit, result$est.results$Y.post.fit)
effect_all <- actual_all - synthetic_all
# 判断置信区间字段名（根据方法选择）
ci_matrix <- switch(ci_method,
gaussian = result$inference.results$CI.all.gaussian,
ls       = result$inference.results$CI.all.ls,
qreg     = result$inference.results$CI.all.qreg,
all      = result$inference.results$CI.all.all)
# 提取 CI（注意左边是下界、右边是上界）
ci_lower <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 1])
ci_upper <- c(rep(NA, length(df_sc$specs$period.pre)), ci_matrix[, 2])
# ========== 画图 ==========
df_effect <- data.frame(
yearq = years_all,
effect = effect_all,
lower = actual_all - ci_upper,
upper = actual_all - ci_lower
)
ggplot(df_effect, aes(x = yearq)) +
geom_line(aes(y = effect), color = "black", linewidth = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), fill = "blue", alpha = 0.3, na.rm = TRUE) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, linetype = "dotted", color = "gray40") +
labs(
title = paste0("政策冲击对GDP增长率的合成效应（CI方法：", ci_method, "）"),
x = "年份（季度）",
y = "政策效应（实际增长率 - 合成增长率）"
) +
theme_minimal()
write_csv(df_effect, "scpi_effect_plot_data.csv")
library(readr)
library(dplyr)
library(ggplot2)
source("C:/Users/浦进博/Desktop/浦进博-连老师/【最重要】研究进度一览/【5】SCM-6月23前出二稿/代码合集/gsynth-master/R/core.R")  # 路径根据你文件位置修改
setwd("C:/Users/浦进博/Desktop/浦进博-连老师/【最重要】研究进度一览/【5】SCM-6月23前出二稿/代码合集/scpi-main/Python")
data <- read_csv("scpi_germany.csv")
# 转为宽格式：每列是国家，每行是年份
data_wide <- data %>%
select(country, year, gdp) %>%
pivot_wider(names_from = country, values_from = gdp) %>%
arrange(year)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
setwd("C:/Users/浦进博/Desktop/浦进博-连老师/【最重要】研究进度一览/【5】SCM-6月23前出二稿/代码合集/scpi-main/Python")
data <- read_csv("scpi_germany.csv")
# 转为宽格式：每列是国家，每行是年份
data_wide <- data %>%
select(country, year, gdp) %>%
pivot_wider(names_from = country, values_from = gdp) %>%
arrange(year)
# 查看前几行
head(data_wide)
View(data_wide)
