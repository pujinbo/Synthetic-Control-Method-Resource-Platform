"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
ci_data<-tibble(
"model"=NA,
"unit"=NA,
"ate"=NA,
# treatment effects at each time period
"te_1"=NA,
"te_2"=NA,
"te_3"=NA,
"te_4"=NA,
"te_5"=NA,
"te_6"=NA,
"te_7"=NA,
"te_8"=NA,
"te_9"=NA,
"te_10"=NA,
"te_11"=NA,
"te_12"=NA,
"te_13"=NA,
"te_14"=NA,
"te_15"=NA,
"te_16"=NA,
"te_17"=NA,
"te_18"=NA,
"te_19"=NA,
"te_20"=NA,
"te_21"=NA,
"te_22"=NA,
"te_23"=NA,
"te_24"=NA,
"te_25"=NA,
"te_26"=NA,
"te_27"=NA,
"te_28"=NA,
"te_29"=NA,
"te_30"=NA,
"te_31"=NA,
# The spread
"spread_1"=NA,
"spread_2"=NA,
"spread_3"=NA,
"spread_4"=NA,
"spread_5"=NA,
"spread_6"=NA,
"spread_7"=NA,
"spread_8"=NA,
"spread_9"=NA,
"spread_10"=NA,
"spread_11"=NA,
"spread_12"=NA,
"spread_13"=NA,
"spread_14"=NA,
"spread_15"=NA,
"spread_16"=NA,
"spread_17"=NA,
"spread_18"=NA,
"spread_19"=NA,
"spread_20"=NA,
"spread_21"=NA,
"spread_22"=NA,
"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
citvp_data<-tibble(
"model"=NA,
"unit"=NA,
"ate"=NA,
# treatment effects at each time period
"te_1"=NA,
"te_2"=NA,
"te_3"=NA,
"te_4"=NA,
"te_5"=NA,
"te_6"=NA,
"te_7"=NA,
"te_8"=NA,
"te_9"=NA,
"te_10"=NA,
"te_11"=NA,
"te_12"=NA,
"te_13"=NA,
"te_14"=NA,
"te_15"=NA,
"te_16"=NA,
"te_17"=NA,
"te_18"=NA,
"te_19"=NA,
"te_20"=NA,
"te_21"=NA,
"te_22"=NA,
"te_23"=NA,
"te_24"=NA,
"te_25"=NA,
"te_26"=NA,
"te_27"=NA,
"te_28"=NA,
"te_29"=NA,
"te_30"=NA,
"te_31"=NA,
# The spread
"spread_1"=NA,
"spread_2"=NA,
"spread_3"=NA,
"spread_4"=NA,
"spread_5"=NA,
"spread_6"=NA,
"spread_7"=NA,
"spread_8"=NA,
"spread_9"=NA,
"spread_10"=NA,
"spread_11"=NA,
"spread_12"=NA,
"spread_13"=NA,
"spread_14"=NA,
"spread_15"=NA,
"spread_16"=NA,
"spread_17"=NA,
"spread_18"=NA,
"spread_19"=NA,
"spread_20"=NA,
"spread_21"=NA,
"spread_22"=NA,
"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
for(i in 1:39){
y<- as.matrix(bl_dat[,i])
x<- as.matrix(bl_dat[,-i])
y.bl   <- tvp_predict(x,y, max.steps = max.steps,burnin = burnin,t_0 = t_0, type = "bl")
y.pred <- y.bl$pred
dat<-cbind(y,x) %>%
as_tibble() %>%
clean_names()
ci<-CausalImpact::CausalImpact(data=dat,
pre.period = c(1,19),
post.period = c(20,31))
ci.tvp <- CausalImpact(dat, pre.period = c(1,t_0), post.period = c(t_0+1,t), model.args = list(dynamic.regression=T))
# saving metrics of interest - All in absolute terms, NOT relative
bltvp_data<-rbind(bltvp_data,
c("BL-TVP",colnames(bl_dat)[i],mean((y[(t_0+1):t]-rowMedians(y.pred)[(t_0+1):t])/y[(t_0+1):t]),
(y-rowMedians(y.pred))/y,
(rowQuantiles(y.pred,probs = .975)-y)/y-(rowQuantiles(y.pred,probs=.025)-y)/y
)
)
ci_data<-rbind(ci_data,
c("CI",colnames(bl_dat)[i],mean((y[(t_0+1):t]-ci$series$point.pred[(t_0+1):t])/y[(t_0+1):t]),
y-ci$series$point.pred,
ci$series$point.pred.upper-ci$series$point.pred.lower
)
)
citvp_data<-rbind(citvp_data,
c("CI-TVP",colnames(bl_dat)[i],mean((y[(t_0+1):t]-ci.tvp$series$point.pred[(t_0+1):t])/y[(t_0+1):t]),
y-ci.tvp$series$point.pred,
ci.tvp$series$point.pred.upper-ci.tvp$series$point.pred.lower
)
)
}
(bltvp_data<-bltvp_data[-1,])
(ci_data <- ci_data[-1,])
(citvp_data <- citvp_data[-1,])
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #set working directory to source file
rbind(bltvp_data,
ci_data,
citvp_data) %>%
write_csv("placebo.csv")
ts.plot(y, ylim=c(0,200))
lines(rowMedians(y.pred),col="green", lwd=2)
lines(rowQuantiles(y.pred,probs=.025),col="green", lty=2)
lines(rowQuantiles(y.pred,probs=.975),col="green", lty=2)
lines(ci$series$point.pred,col="blue", lwd=2)
lines(ci$series$point.pred.lower,col="blue", lty=2)
lines(ci$series$point.pred.upper,col="blue", lty=2)
lines(ci.tvp$series$point.pred,col="red", lwd=2)
lines(ci.tvp$series$point.pred.lower,col="red", lty=2)
lines(ci.tvp$series$point.pred.upper,col="red", lty=2)
abline(v=19)
tribble(~"method",~"MSFE",
"BL-TVP",sum((y[t_0:t]-rowMedians(y.pred)[t_0:t])^2),
"CI",sum((y[t_0:t]-(ci$series$point.pred)[t_0:t])^2),
"CI-TVP",sum((y[t_0:t]-(ci.tvp$series$point.pred)[t_0:t])^2)
)
plot(rowQuantiles(y.pred,probs=.975)-rowQuantiles(y.pred,probs=.025),col="green", ylim=c(0,100))
points(ci$series$point.pred.upper-ci$series$point.pred.lower,col="blue")
points(ci.tvp$series$point.pred.upper-ci.tvp$series$point.pred.lower,col="red")
abline(v=19)
#https://scunning.com/cunningham_mixtape.pdf
# 3 is CA
# Treatment 1988 (19th)
rm(list=ls()) #clear everything
# loading data ------------------------------------------------------------
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #set working directory to source file
devtools::install_github('johnson-shuffle/mixtape') #download data thank you cunningham
library(tidysynth)
library(mixtape)
library(janitor)
bl_dat <- mixtape::smoking
library(haven)
library(tidyverse)
# cleaning data -----------------------------------------------------------
data("smoking")
setwd("../../01-model") #Moving to get my model
source("mod_scaled_predict.R") #upload model
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
bl_dat <- smoking %>%
dplyr::select(year, state, cigsale) %>%
filter(state!="California") %>%
type_convert() %>%
pivot_wider(names_from = state, values_from = cigsale) %>%
dplyr::select(-year)
bl_dat<-bl_dat %>%
clean_names()
# loading time ------------------------------------------------------------------
t_0 <- 19
t<-31
#bltvp
max.steps=20000
burnin=10000
# creating holding vector -------------------------------------------------
bltvp_data<-tibble(
"model"=NA,
"unit"=NA,
"ate"=NA,
# treatment effects at each time period
"te_1"=NA,
"te_2"=NA,
"te_3"=NA,
"te_4"=NA,
"te_5"=NA,
"te_6"=NA,
"te_7"=NA,
"te_8"=NA,
"te_9"=NA,
"te_10"=NA,
"te_11"=NA,
"te_12"=NA,
"te_13"=NA,
"te_14"=NA,
"te_15"=NA,
"te_16"=NA,
"te_17"=NA,
"te_18"=NA,
"te_19"=NA,
"te_20"=NA,
"te_21"=NA,
"te_22"=NA,
"te_23"=NA,
"te_24"=NA,
"te_25"=NA,
"te_26"=NA,
"te_27"=NA,
"te_28"=NA,
"te_29"=NA,
"te_30"=NA,
"te_31"=NA,
# The spread
"spread_1"=NA,
"spread_2"=NA,
"spread_3"=NA,
"spread_4"=NA,
"spread_5"=NA,
"spread_6"=NA,
"spread_7"=NA,
"spread_8"=NA,
"spread_9"=NA,
"spread_10"=NA,
"spread_11"=NA,
"spread_12"=NA,
"spread_13"=NA,
"spread_14"=NA,
"spread_15"=NA,
"spread_16"=NA,
"spread_17"=NA,
"spread_18"=NA,
"spread_19"=NA,
"spread_20"=NA,
"spread_21"=NA,
"spread_22"=NA,
"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
ci_data<-tibble(
"model"=NA,
"unit"=NA,
"ate"=NA,
# treatment effects at each time period
"te_1"=NA,
"te_2"=NA,
"te_3"=NA,
"te_4"=NA,
"te_5"=NA,
"te_6"=NA,
"te_7"=NA,
"te_8"=NA,
"te_9"=NA,
"te_10"=NA,
"te_11"=NA,
"te_12"=NA,
"te_13"=NA,
"te_14"=NA,
"te_15"=NA,
"te_16"=NA,
"te_17"=NA,
"te_18"=NA,
"te_19"=NA,
"te_20"=NA,
"te_21"=NA,
"te_22"=NA,
"te_23"=NA,
"te_24"=NA,
"te_25"=NA,
"te_26"=NA,
"te_27"=NA,
"te_28"=NA,
"te_29"=NA,
"te_30"=NA,
"te_31"=NA,
# The spread
"spread_1"=NA,
"spread_2"=NA,
"spread_3"=NA,
"spread_4"=NA,
"spread_5"=NA,
"spread_6"=NA,
"spread_7"=NA,
"spread_8"=NA,
"spread_9"=NA,
"spread_10"=NA,
"spread_11"=NA,
"spread_12"=NA,
"spread_13"=NA,
"spread_14"=NA,
"spread_15"=NA,
"spread_16"=NA,
"spread_17"=NA,
"spread_18"=NA,
"spread_19"=NA,
"spread_20"=NA,
"spread_21"=NA,
"spread_22"=NA,
"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
citvp_data<-tibble(
"model"=NA,
"unit"=NA,
"ate"=NA,
# treatment effects at each time period
"te_1"=NA,
"te_2"=NA,
"te_3"=NA,
"te_4"=NA,
"te_5"=NA,
"te_6"=NA,
"te_7"=NA,
"te_8"=NA,
"te_9"=NA,
"te_10"=NA,
"te_11"=NA,
"te_12"=NA,
"te_13"=NA,
"te_14"=NA,
"te_15"=NA,
"te_16"=NA,
"te_17"=NA,
"te_18"=NA,
"te_19"=NA,
"te_20"=NA,
"te_21"=NA,
"te_22"=NA,
"te_23"=NA,
"te_24"=NA,
"te_25"=NA,
"te_26"=NA,
"te_27"=NA,
"te_28"=NA,
"te_29"=NA,
"te_30"=NA,
"te_31"=NA,
# The spread
"spread_1"=NA,
"spread_2"=NA,
"spread_3"=NA,
"spread_4"=NA,
"spread_5"=NA,
"spread_6"=NA,
"spread_7"=NA,
"spread_8"=NA,
"spread_9"=NA,
"spread_10"=NA,
"spread_11"=NA,
"spread_12"=NA,
"spread_13"=NA,
"spread_14"=NA,
"spread_15"=NA,
"spread_16"=NA,
"spread_17"=NA,
"spread_18"=NA,
"spread_19"=NA,
"spread_20"=NA,
"spread_21"=NA,
"spread_22"=NA,
"spread_23"=NA,
"spread_24"=NA,
"spread_25"=NA,
"spread_26"=NA,
"spread_27"=NA,
"spread_28"=NA,
"spread_29"=NA,
"spread_30"=NA,
"spread_31"=NA
)
for(i in 1:39){
y<- as.matrix(bl_dat[,i])
x<- as.matrix(bl_dat[,-i])
y.bl   <- tvp_predict(x,y, max.steps = max.steps,burnin = burnin,t_0 = t_0, type = "bl")
y.pred <- y.bl$pred
dat<-cbind(y,x) %>%
as_tibble() %>%
clean_names()
ci<-CausalImpact::CausalImpact(data=dat,
pre.period = c(1,19),
post.period = c(20,31))
ci.tvp <- CausalImpact(dat, pre.period = c(1,t_0), post.period = c(t_0+1,t), model.args = list(dynamic.regression=T))
# saving metrics of interest - All in absolute terms, NOT relative
bltvp_data<-rbind(bltvp_data,
c("BL-TVP",colnames(bl_dat)[i],mean((y[(t_0+1):t]-rowMedians(y.pred)[(t_0+1):t])/y[(t_0+1):t]),
(y-rowMedians(y.pred))/y,
(rowQuantiles(y.pred,probs = .975)-y)/y-(rowQuantiles(y.pred,probs=.025)-y)/y
)
)
ci_data<-rbind(ci_data,
c("CI",colnames(bl_dat)[i],mean((y[(t_0+1):t]-ci$series$point.pred[(t_0+1):t])/y[(t_0+1):t]),
y-ci$series$point.pred,
ci$series$point.pred.upper-ci$series$point.pred.lower
)
)
citvp_data<-rbind(citvp_data,
c("CI-TVP",colnames(bl_dat)[i],mean((y[(t_0+1):t]-ci.tvp$series$point.pred[(t_0+1):t])/y[(t_0+1):t]),
y-ci.tvp$series$point.pred,
ci.tvp$series$point.pred.upper-ci.tvp$series$point.pred.lower
)
)
}
(bltvp_data<-bltvp_data[-1,])
(ci_data <- ci_data[-1,])
(citvp_data <- citvp_data[-1,])
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #set working directory to source file
rbind(bltvp_data,
ci_data,
citvp_data) %>%
write_csv("placebo.csv")
ts.plot(y, ylim=c(0,200))
lines(rowMedians(y.pred),col="green", lwd=2)
lines(rowQuantiles(y.pred,probs=.025),col="green", lty=2)
lines(rowQuantiles(y.pred,probs=.975),col="green", lty=2)
lines(ci$series$point.pred,col="blue", lwd=2)
lines(ci$series$point.pred.lower,col="blue", lty=2)
lines(ci$series$point.pred.upper,col="blue", lty=2)
lines(ci.tvp$series$point.pred,col="red", lwd=2)
lines(ci.tvp$series$point.pred.lower,col="red", lty=2)
lines(ci.tvp$series$point.pred.upper,col="red", lty=2)
abline(v=19)
tribble(~"method",~"MSFE",
"BL-TVP",sum((y[t_0:t]-rowMedians(y.pred)[t_0:t])^2),
"CI",sum((y[t_0:t]-(ci$series$point.pred)[t_0:t])^2),
"CI-TVP",sum((y[t_0:t]-(ci.tvp$series$point.pred)[t_0:t])^2)
)
plot(rowQuantiles(y.pred,probs=.975)-rowQuantiles(y.pred,probs=.025),col="green", ylim=c(0,100))
points(ci$series$point.pred.upper-ci$series$point.pred.lower,col="blue")
points(ci.tvp$series$point.pred.upper-ci.tvp$series$point.pred.lower,col="red")
abline(v=19)
rbind(bltvp_data,
ci_data,
citvp_data) %>%
View(.)
